<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Dulcini - Leitor de XML de Nota Fiscal</title>
  <link rel="icon" href="img/icon dulcini.png" type="image/x-icon">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <img src="img/logo-dulcini.png" alt="Dulcini" style="max-width:220px;max-height:70px;margin-bottom:0.3em;">
    <h2>Leitor de XML de Nota Fiscal</h2>
     <a href="index.html" style="position:absolute;top:1.5em;right:1.5em;background:#1bb36a;color:#fff;padding:0.6em 1.2em;border-radius:6px;text-decoration:none;font-weight:600;transition:all 0.3s ease;display:flex;align-items:center;gap:0.5em;" onmouseover="this.style.background='#3be88a'" onmouseout="this.style.background='#1bb36a'"><img src="img/icon home.png" alt="Home" style="width:20px;height:20px;"> Home</a>
  </header>

  <main>
    <p>Selecione um ou mais arquivos XML de nota fiscal para extrair os dados:</p>
    <button id="btnLimpar" style="float:right;margin-bottom:1em;background:#c82333;color:#fff;font-weight:bold;border:none;padding:0.5em 1.2em;border-radius:6px;cursor:pointer;">Apagar todas as informações</button>

    <div>  
      <label for="xmlInput" class="custom-file-label" tabindex="0">Escolher arquivos XML</label>
      <input type="file" id="xmlInput" multiple accept=".xml">
    </div>

    <label for="filtroStatus">Filtrar por status:</label>
    <select id="filtroStatus">
      <option value="todos">Todos</option>
      <option value="pendente">Pendentes</option>
      <option value="descarregado">Descarregadas</option>
    </select>

    <table id="resultTable" style="display:none;">
      <thead>
        <tr>
          <th>Descarregada?</th>
          <th>Número da Nota</th>
          <th>Usina</th>
          <th>Peso Líquido (t)</th>
          <th>Valor Unitário</th>
          <th>Valor Total</th>
          <th>
            Data de Emissão
            <input type="date" id="filtroData" style="font-size:0.95em;max-width:120px;display:inline-block;margin-left:0.5em;vertical-align:middle;">
          </th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <footer style="text-align:center;padding:1em;color:#7a9;margin-top:2em;">© 2025 Dulcini & Centrosucar. Desenvolvido por Julio Davi</footer>

  <script>
    // Acessibilidade: permite abrir o seletor de arquivos com Enter ou Espaço
    document.querySelector('.custom-file-label').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        document.getElementById('xmlInput').click();
      }
    });

    // Botão limpar tudo
    document.getElementById('btnLimpar').onclick = function() {
      if (confirm('Tem certeza que deseja apagar todas as informações?')) {
        localStorage.removeItem('notasNFe');
        renderizarTabela();
        document.getElementById('filtroData').value = '';
        document.getElementById('filtroStatus').value = 'todos';
      }
    };

    // Utilidades de armazenamento local
    function salvarNotas(notas) {
      localStorage.setItem('notasNFe', JSON.stringify(notas));
    }

    function carregarNotas() {
      return JSON.parse(localStorage.getItem('notasNFe') || '[]');
    }

    // Função principal de renderização da tabela
    function renderizarTabela(filtroStatus = 'todos', filtroData = '') {
      const table = document.getElementById('resultTable');
      const tbody = table.querySelector('tbody');
      const notas = carregarNotas();
      tbody.innerHTML = '';

      let notasFiltradas = notas;
      if (filtroStatus === 'pendente') notasFiltradas = notasFiltradas.filter(n => !n.descarregada);
      if (filtroStatus === 'descarregado') notasFiltradas = notasFiltradas.filter(n => n.descarregada);
      if (filtroData) notasFiltradas = notasFiltradas.filter(n => n.dataEmissao === filtroData);

      if (notasFiltradas.length === 0) {
        table.style.display = '';
        tbody.innerHTML = `<tr><td colspan="8" style="color:#888;background:#e6fff2;font-style:italic;">Nenhuma nota encontrada para o filtro selecionado.</td></tr>`;
        return;
      }

      const usinas = {};
      notasFiltradas.forEach(nota => {
        if (!usinas[nota.usina]) usinas[nota.usina] = [];
        usinas[nota.usina].push(nota);
      });

      table.style.display = '';
      let somaPeso = 0;
      let somaValorTotal = 0;
      let somaValorUnit = 0;
      let countValorUnit = 0;

      Object.keys(usinas).forEach(usina => {
        usinas[usina].sort((a, b) => {
          const nA = parseInt(a.numeroNota.replace(/\D/g, ''));
          const nB = parseInt(b.numeroNota.replace(/\D/g, ''));
          return nA - nB;
        });

        const rowUsina = `<tr class="usina-header"><td colspan="8">${usina}</td></tr>`;
        tbody.insertAdjacentHTML('beforeend', rowUsina);

        usinas[usina].forEach(nota => {
          let peso = parseFloat((nota.pesoLiq || '0').replace(/\./g, '').replace(',', '.'));
          if (!isNaN(peso)) somaPeso += peso;

          let vTot = parseFloat((nota.valorTot || '0').replace(/\./g, '').replace(',', '.'));
          if (!isNaN(vTot)) somaValorTotal += vTot;

          let vUnit = parseFloat((nota.valorUnit || '0').replace(/\./g, '').replace(',', '.'));
          if (!isNaN(vUnit)) { somaValorUnit += vUnit; countValorUnit++; }

          const checked = nota.descarregada ? 'checked' : '';
          const row = `<tr>
            <td><input type="checkbox" data-idx="${nota.id}" ${checked}></td>
            <td>${nota.numeroNota}</td>
            <td>${nota.usina}</td>
            <td>${nota.pesoLiq}</td>
            <td>${nota.valorUnit}</td>
            <td>${nota.valorTot}</td>
            <td>${nota.dataEmissaoFormatada || ''}</td>
            <td><button class="btn-apagar" data-id="${nota.id}" style="background:#fff0f0;color:#a00;border:1px solid #a00;padding:0.2em 0.7em;border-radius:5px;cursor:pointer;font-size:0.95em;">Apagar</button></td>
          </tr>`;
          tbody.insertAdjacentHTML('beforeend', row);
        });
      });

      if (notasFiltradas.length > 0) {
        const mediaValorUnit = countValorUnit > 0 ? somaValorUnit / countValorUnit : 0;
        const linhaTotais = `<tr style="background:#f7f7e6;font-weight:700;">
          <td></td>
          <td colspan="2" style="text-align:right;">Totais Gerais:</td>
          <td>${somaPeso.toLocaleString('pt-BR', {minimumFractionDigits:3, maximumFractionDigits:3})}</td>
          <td>${mediaValorUnit.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
          <td>${somaValorTotal.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
          <td colspan="2"></td>
        </tr>`;
        tbody.insertAdjacentHTML('beforeend', linhaTotais);
      }
    } // ✅ função renderizarTabela fechada corretamente aqui


    // -----------------------
    // EVENT LISTENERS GLOBAIS
    // -----------------------

    // Apagar nota individual
    document.addEventListener('click', function(e) {
      if (e.target.classList && e.target.classList.contains('btn-apagar')) {
        if (confirm('Deseja apagar esta nota?')) {
          const id = e.target.getAttribute('data-id');
          let notas = carregarNotas();
          notas = notas.filter(n => n.id != id);
          salvarNotas(notas);
          renderizarTabela(document.getElementById('filtroStatus').value, document.getElementById('filtroData').value);
        }
      }
    });

    // Atualizar status "descarregada"
    document.getElementById('resultTable').addEventListener('change', function(e) {
      if (e.target.type === 'checkbox') {
        const idx = e.target.getAttribute('data-idx');
        const notas = carregarNotas();
        const nota = notas.find(n => n.id == idx);
        if (nota) {
          nota.descarregada = e.target.checked;
          salvarNotas(notas);
          renderizarTabela(document.getElementById('filtroStatus').value);
        }
      }
    });

    // Filtros
    document.getElementById('filtroStatus').addEventListener('change', function(e) {
      renderizarTabela(e.target.value, document.getElementById('filtroData').value);
    });
    document.getElementById('filtroData').addEventListener('change', function(e) {
      renderizarTabela(document.getElementById('filtroStatus').value, e.target.value);
    });

    // Leitura de XML
    document.getElementById('xmlInput').addEventListener('change', function(event) {
      const files = event.target.files;
      if (files.length === 0) {
        renderizarTabela(document.getElementById('filtroStatus').value);
        return;
      }

      let notas = carregarNotas();
      let nextId = notas.length > 0 ? Math.max(...notas.map(n => n.id)) + 1 : 1;

      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const parser = new DOMParser();
          const xml = parser.parseFromString(e.target.result, 'application/xml');

          function getTag(pathArr) {
            let el = xml.documentElement;
            for (const tag of pathArr) {
              el = el && (el.getElementsByTagName(tag)[0] || el.getElementsByTagName('nfe:' + tag)[0]);
            }
            return el ? el.textContent : '';
          }

          const numeroNota = getTag(['ide','nNF']);
          const dataEmissaoRaw = getTag(['ide','dhEmi']) || getTag(['ide','dEmi']);
          let dataEmissao = '', dataEmissaoFormatada = '';
          if (dataEmissaoRaw) {
            let ano, mes, dia;
            if (dataEmissaoRaw.includes('-')) {
              ano = dataEmissaoRaw.substring(0, 4);
              mes = dataEmissaoRaw.substring(5, 7);
              dia = dataEmissaoRaw.substring(8, 10);
            } else {
              ano = dataEmissaoRaw.substring(0,4);
              mes = dataEmissaoRaw.substring(4,6);
              dia = dataEmissaoRaw.substring(6,8);
            }
            dataEmissao = `${ano}-${mes}-${dia}`;
            dataEmissaoFormatada = `${dia}/${mes}/${ano}`;
          }

          const usina = getTag(['emit','xFant']);
          let qCom = getTag(['det','prod','qCom']);
          let uCom = getTag(['det','prod','uCom']); // extrair unidade
          let valorUnit = getTag(['det','prod','vUnCom']);
          let valorTot = getTag(['det','prod','vProd']);
          let pesoLiq = qCom;
          // usamos qCom como peso líquido padrão

          // Convertendo para números reais
          let qtd = parseFloat((qCom || '0').replace(',', '.'));
          let vUnit = parseFloat((valorUnit || '0').replace(',', '.'));
          let vTot = parseFloat((valorTot || '0').replace(',', '.'));

          // Converter para toneladas conforme unidade informada
          if (uCom && uCom.toUpperCase() === 'KG') {
            // Se a unidade é KG, converte para toneladas
            pesoLiq = qtd / 1000;
            vUnit = vUnit * 1000; // converter R$/kg → R$/t
          } else {
            // Caso contrário, assume que já está em toneladas
            pesoLiq = qtd;
          }

          // Formatando valores
            pesoLiq = pesoLiq.toLocaleString('pt-BR', { minimumFractionDigits:3, maximumFractionDigits:3 });
            valorUnit = vUnit.toLocaleString('pt-BR', { minimumFractionDigits:2, maximumFractionDigits:2 });
            valorTot = vTot.toLocaleString('pt-BR', { minimumFractionDigits:2, maximumFractionDigits:2 });


          notas.push({
            id: nextId++,
            numeroNota, dataEmissao, dataEmissaoFormatada, usina, pesoLiq, valorUnit, valorTot,
            descarregada: false
          });

          salvarNotas(notas);
          renderizarTabela(document.getElementById('filtroStatus').value, document.getElementById('filtroData').value);
        };
        reader.readAsText(file);
      });
    });

    // Renderizar tabela ao abrir a página
    renderizarTabela();
  </script>
</body>
</html>
