<!DOCTYPE html>

<html lang="pt-br">

<head>

  <meta charset="UTF-8">

  <title>Dulcini - Leitor de XML de Nota Fiscal</title>

  <link rel="icon" href="img/icon dulcini.png" type="image/x-icon">

  <link rel="stylesheet" href="style.css">

</head>

<body>

  <header>

    <img src="img/logo-dulcini.avif" alt="Dulcini" style="max-width:220px;max-height:70px;margin-bottom:0.3em;">

    <h2>Leitor de XML de Nota Fiscal</h2>

  </header>

  <main>

    <p>Selecione um ou mais arquivos XML de nota fiscal para extrair os dados:</p>

    <button id="btnLimpar" style="float:right;margin-bottom:1em;background:#c82333;color:#fff;font-weight:bold;border:none;padding:0.5em 1.2em;border-radius:6px;cursor:pointer;">Apagar todas as informações</button>

   

    <div>  

      <label for="xmlInput" class="custom-file-label" tabindex="0">Escolher arquivos XML</label>

      <input type="file" id="xmlInput" multiple accept=".xml">

    </div>

 

    <label for="filtroStatus">Filtrar por status:</label>

    <select id="filtroStatus">

      <option value="todos">Todos</option>

      <option value="pendente">Pendentes</option>

      <option value="descarregado">Descarregadas</option>

    </select>

 

    <table id="resultTable" style="display:none;">

      <thead>

        <tr>

          <th>Descarregada?</th>

          <th>Número da Nota</th>

          <th>Usina</th>

          <th>Peso Líquido (t)</th>

          <th>Valor Unitário</th>

          <th>Valor Total</th>

          <th>

            Data de Emissão

            <input type="date" id="filtroData" style="font-size:0.95em;max-width:120px;display:inline-block;margin-left:0.5em;vertical-align:middle;">

          </th>

          <th>Ações</th>

        </tr>

      </thead>

      <tbody></tbody>

    </table>

  </main>

 

  <script>

    // Verifica se localStorage está disponível

    let storageAtivo = true;

    try {

      localStorage.setItem('testeLocalStorage', 'ok');

      localStorage.removeItem('testeLocalStorage');

    } catch (e) {

      storageAtivo = false;

      alert("⚠️ Atenção: O armazenamento local (localStorage) está bloqueado neste navegador. As notas não serão salvas.");

    }

 

    // Funções utilitárias com tratamento de erro

    function salvarNotas(notas) {

      if (!storageAtivo) return;

      try {

        localStorage.setItem('notasNFe', JSON.stringify(notas));

      } catch (e) {

        alert("❌ Erro ao salvar dados no armazenamento local:\n" + e.message);

      }

    }

 

    function carregarNotas() {

      if (!storageAtivo) return [];

      try {

        return JSON.parse(localStorage.getItem('notasNFe') || '[]');

      } catch (e) {

        alert("❌ Erro ao carregar notas salvas:\n" + e.message);

        return [];

      }

    }

 

    document.querySelector('.custom-file-label').addEventListener('keydown', function(e) {

      if (e.key === 'Enter' || e.key === ' ') {

        document.getElementById('xmlInput').click();

      }

    });

 

    document.getElementById('btnLimpar').onclick = function() {

      if (confirm('Tem certeza que deseja apagar todas as informações?')) {

        if (storageAtivo) localStorage.removeItem('notasNFe');

        renderizarTabela();

        document.getElementById('filtroData').value = '';

        document.getElementById('filtroStatus').value = 'todos';

      }

    };

 

    function renderizarTabela(filtroStatus = 'todos', filtroData = '') {

      try {

        const table = document.getElementById('resultTable');

        const tbody = table.querySelector('tbody');

        const notas = carregarNotas();

        tbody.innerHTML = '';

        let notasFiltradas = notas;

        if (filtroStatus === 'pendente') notasFiltradas = notasFiltradas.filter(n => !n.descarregada);

        if (filtroStatus === 'descarregado') notasFiltradas = notasFiltradas.filter(n => n.descarregada);

        if (filtroData) notasFiltradas = notasFiltradas.filter(n => n.dataEmissao === filtroData);

 

        if (notasFiltradas.length === 0) {

          table.style.display = '';

          tbody.innerHTML = `<tr><td colspan="8" style="color:#888;background:#e6fff2;font-style:italic;">Nenhuma nota encontrada para o filtro selecionado.</td></tr>`;

          return;

        }

 

        const usinas = {};

        notasFiltradas.forEach(nota => {

          if (!usinas[nota.usina]) usinas[nota.usina] = [];

          usinas[nota.usina].push(nota);

        });

        table.style.display = '';

 

        let somaPeso = 0, somaValorTotal = 0, somaValorUnit = 0, countValorUnit = 0;

        Object.keys(usinas).forEach(usina => {

          usinas[usina].sort((a, b) => parseInt(a.numeroNota) - parseInt(b.numeroNota));

          const rowUsina = `<tr class="usina-header"><td colspan="8">${usina}</td></tr>`;

          tbody.insertAdjacentHTML('beforeend', rowUsina);

 

          usinas[usina].forEach(nota => {

            let peso = parseFloat((nota.pesoLiq || "0").replace(/\./g, '').replace(',', '.')) || 0;

            somaPeso += peso;

            let vTot = parseFloat((nota.valorTot || "0").replace(/\./g, '').replace(',', '.')) || 0;

            somaValorTotal += vTot;

            let vUnit = parseFloat((nota.valorUnit || "0").replace(/\./g, '').replace(',', '.')) || 0;

            if (!isNaN(vUnit)) { somaValorUnit += vUnit; countValorUnit++; }

 

            const checked = nota.descarregada ? 'checked' : '';

            const row = `<tr>

              <td><input type="checkbox" data-idx="${nota.id}" ${checked}></td>

              <td>${nota.numeroNota}</td>

              <td>${nota.usina}</td>

              <td>${nota.pesoLiq}</td>

              <td>${nota.valorUnit}</td>

              <td>${nota.valorTot}</td>

              <td>${nota.dataEmissaoFormatada || ''}</td>

              <td><button class="btn-apagar" data-id="${nota.id}" style="background:#fff0f0;color:#a00;border:1px solid #a00;padding:0.2em 0.7em;border-radius:5px;cursor:pointer;font-size:0.95em;">Apagar</button></td>

            </tr>`;

            tbody.insertAdjacentHTML('beforeend', row);

          });

        });

 

        if (notasFiltradas.length > 0) {

          const mediaValorUnit = countValorUnit > 0 ? somaValorUnit / countValorUnit : 0;

          const linhaTotais = `<tr style="background:#f7f7e6;font-weight:700;">

            <td colspan="1"></td>

            <td colspan="2" style="text-align:right;">Totais Gerais:</td>

            <td>${somaPeso.toLocaleString('pt-BR', {minimumFractionDigits:3, maximumFractionDigits:3})}</td>

            <td>${mediaValorUnit.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2})}</td>

            <td>${somaValorTotal.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2})}</td>

            <td colspan="2"></td>

          </tr>`;

          tbody.insertAdjacentHTML('beforeend', linhaTotais);

        }

      } catch (e) {

        alert("❌ Erro ao renderizar tabela:\n" + e.message);

      }

    }

 

    document.addEventListener('click', function(e) {

      if (e.target.classList && e.target.classList.contains('btn-apagar')) {

        if (confirm('Deseja apagar esta nota?')) {

          const id = e.target.getAttribute('data-id');

          let notas = carregarNotas();

          notas = notas.filter(n => n.id != id);

          salvarNotas(notas);

          renderizarTabela(document.getElementById('filtroStatus').value, document.getElementById('filtroData').value);

        }

      }

    });

 

    document.getElementById('resultTable').addEventListener('change', function(e) {

      if (e.target.type === 'checkbox') {

        const idx = e.target.getAttribute('data-idx');

        const notas = carregarNotas();

        const nota = notas.find(n => n.id == idx);

        if (nota) {

          nota.descarregada = e.target.checked;

          salvarNotas(notas);

          renderizarTabela(document.getElementById('filtroStatus').value);

         

          setTimeout(() => {

        const linha = document.querySelector(`input[data-idx="${idx}"]`)?.closest('tr');

        if (linha && nota.descarregada) {

          linha.classList.add('descarregada', 'ativar-animacao');

          setTimeout(() => linha.classList.remove('ativar-animacao'), 1000);

  }

}, 100);

        }

      }

    });

 

    document.getElementById('filtroStatus').addEventListener('change', function(e) {

      renderizarTabela(e.target.value, document.getElementById('filtroData').value);

    });

    document.getElementById('filtroData').addEventListener('change', function(e) {

      renderizarTabela(document.getElementById('filtroStatus').value, e.target.value);

    });

 

    document.getElementById('xmlInput').addEventListener('change', function(event) {

      const files = event.target.files;

      if (files.length === 0) {

        renderizarTabela(document.getElementById('filtroStatus').value);

        return;

      }

      try {

        let notas = carregarNotas();

        let nextId = notas.length > 0 ? Math.max(...notas.map(n => n.id)) + 1 : 1;

 

        Array.from(files).forEach(file => {

          const reader = new FileReader();

          reader.onload = function(e) {

  try {

    const parser = new DOMParser();

    const xml = parser.parseFromString(e.target.result, 'application/xml');

    function getTag(pathArr) {

      let el = xml.documentElement;

      for (const tag of pathArr) {

        el = el && (el.getElementsByTagName(tag)[0] || el.getElementsByTagName('nfe:' + tag)[0]);

      }

      return el ? el.textContent : '';

    }

 

    const numeroNota = getTag(['ide','nNF']);

    const dataEmissaoRaw = getTag(['ide','dhEmi']) || getTag(['ide','dEmi']);

    let dataEmissao = '', dataEmissaoFormatada = '';

    if (dataEmissaoRaw) {

      let ano, mes, dia;

      if (dataEmissaoRaw.includes('-')) {

        ano = dataEmissaoRaw.substring(0, 4);

        mes = dataEmissaoRaw.substring(5, 7);

        dia = dataEmissaoRaw.substring(8, 10);

      } else {

        ano = dataEmissaoRaw.substring(0,4);

        mes = dataEmissaoRaw.substring(4,6);

        dia = dataEmissaoRaw.substring(6,8);

      }

      dataEmissao = `${ano}-${mes}-${dia}`;

      dataEmissaoFormatada = `${dia}/${mes}/${ano}`;

    }

 

    const usina = getTag(['emit', 'xFant']) || getTag(['emit', 'xNome']) || 'Não informada';

 

    let quantidade = getTag(['det', 'prod', 'qCom']);

    let valorUnitarioBruto = getTag(['det', 'prod', 'vUnCom']);

    let valorTotalBruto = getTag(['det', 'prod', 'vProd']);

 

    let qCom = parseFloat(quantidade.replace(',', '.')) || 0;

    let vUnCom = parseFloat(valorUnitarioBruto.replace(',', '.')) || 0;

    let vTot = parseFloat(valorTotalBruto.replace(',', '.')) || 0;

 // Detectar automaticamente o tipo da nota (nova ou antiga)
let tipoNovo = false;
if (vUnCom > 1000) {
  tipoNovo = true; // valor unitário alto => R$/t
} else if (vUnCom < 100 && qCom > 1000) {
  tipoNovo = false; // valor unitário baixo e quantidade muito alta => kg
}

// Ajustar valores conforme tipo detectado
    let pesoLiq = tipoNovo ? qCom : qCom / 1000;
    let valorUnit = tipoNovo ? vUnCom : vUnCom * 1000;
    let valorTot = vTot;

 

    // Formatar para exibição

    pesoLiq = pesoLiq.toLocaleString('pt-BR', {minimumFractionDigits:3, maximumFractionDigits:3});

    valorUnit = Math.round(valorUnit).toLocaleString('pt-BR');

    valorTot = Math.round(valorTot).toLocaleString('pt-BR');

 

    notas.push({

      id: nextId++,

      numeroNota,

      dataEmissao,

      dataEmissaoFormatada,

      usina,

      pesoLiq,

      valorUnit,

      valorTot,

      descarregada: false

    });

 

    salvarNotas(notas);

    renderizarTabela(

      document.getElementById('filtroStatus').value,

      document.getElementById('filtroData').value

    );

  } catch (err) {

    alert("❌ Erro ao ler o arquivo XML: " + file.name + "\n" + err.message);

  }

};

          reader.onerror = () => alert("❌ Erro ao abrir o arquivo: " + file.name);

          reader.readAsText(file);

        });

      } catch (err) {

        alert("❌ Erro inesperado ao processar arquivos:\n" + err.message);

      }

    });

 

    renderizarTabela();

  </script>

</body>

</html>

 


